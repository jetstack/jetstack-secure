# if changing this name, also update promotion.yaml
name: release-master

on:
  push:
    branches:
      - master
    tags:
      - v*
jobs:
  vet:
    name: vet
    runs-on: ubuntu-20.04
    container: golang:1.18
    steps:
    - uses: actions/checkout@v3
    - run: make vet
      shell: bash
  test:
    name: go test
    runs-on: ubuntu-20.04
    container: golang:1.18
    steps:
    - uses: actions/checkout@v3
    - run: make test
  docker_build:
    name: docker_build
    runs-on: ubuntu-20.04
    container:
      image: docker:20.10.5
      options: -t
    # Setting up dind service container
    services:
      docker:
        image: docker:20.10.5-dind
        env:
          DOCKER_DRIVER: overlay
          DOCKER_HOST: tcp://localhost:2375
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
    - name: Install Tools
      # Installing 'bash' because it's required by the 'cosign-installer' action
      # and 'coreutils' because the 'slsa-provenance-action' requires a version
      # of 'base64' that supports the -w flag.
      run: apk add --update make git jq rsync curl bash coreutils
    - name: Adding github workspace as safe directory
      # See issue https://github.com/actions/checkout/issues/760
      run: git config --global --add safe.directory $GITHUB_WORKSPACE
    - name: Install cosign
      uses: sigstore/cosign-installer@581838fbedd492d2350a9ecd427a95d6de1e5d01
      with:
        cosign-release: v1.5.2
    - name: Install Syft
      uses: anchore/sbom-action/download-syft@2ad78246293830258e98b4e707b1fb02d0242828
    - uses: actions/checkout@v3
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      with:
        driver-opts: image=moby/buildkit:master
    - name: Login to quay.io
      uses: docker/login-action@v2
      with:
        registry: quay.io
        username: ${{ secrets.QUAY_USER }}
        password: ${{ secrets.QUAY_PASSWORD }}
    - name: Login to ghcr.io
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build and push
      run: make push-docker-image
    - name: Sign
      run: make sign-docker-image
    - name: SBOM
      run: make sbom-docker-image
    # The slsa-provenance-action generates a full attestation from an artifact
    # as the subject. However, cosign only expects the predicate portion of
    # the attestation and figures out the subject itself from the image.
    #
    # So, we generate a fake artifact and then strip everything but the
    # predicate out from the generated attestation.
    - name: Create mock artifact
      run: echo "foobar" > mock
    - name: Generate provenance
      uses: philips-labs/SLSA-Provenance-Action@dddb40e199ae28d4cd2f17bad7f31545556fdd3d
      with:
        command: generate
        subcommand: files
        arguments: --artifact-path mock
    - name: Extract predicate
      run: jq '.predicate' provenance.json > predicate.json
    - name: Attest
      run: make attest-docker-image
